using panaedra.msroot.msutil.logic.*.
using panaedra.msroot.msutil.interfaces.*.
using panaedra.msroot.mspy.logic.*.

{panaedra/msroot/msutil/logic/top_i/ctop_class.i} 

class panaedra.msroot.mspy.logic.sc_mspython: 

  /****************************** Source Header ********************************\

      Description: Logic for communicating with the qx_python local session python interpreter

  \*****************************  Include Files ********************************/

  /******************************* $NoKeywords:  $ *****************************/
  
  define protected static variable oPythonSysInterpreter as c_mspython_sys_interpreter no-undo.
  define protected static variable bInitialized          as logical                    no-undo.
  
  method public static logical MsPythonInitialize():
    
    /* 
      Initialize the Python interpreter of this session/process. 
      May be called multiple times, does nothing if already initialized.
    */
    
    define variable oOvid# as sc_mspython     no-undo.
    define variable oPy#   as c_mspython_call no-undo.
    
    {panaedra/msroot/msutil/logic/sc_unix_set_libpath.i}
    
    if not valid-object(oPythonSysInterpreter) then 
    do:
      if not bInitialized then 
      do:
        bInitialized = true. 
        /* Note: this 'double check' via bInitialized is done because the progress procedure editor (_edit.r) 
           cleans up objects without calling its destructor, or (ofcourse) without broadcasting the evt@SessionClose 
           event.
           Initializing the python interpreter twice, causes a crash plus core dump.
           The static boolean is not affected by the procedure editor, unless this static class is reloaded
           within the progress runtime (which is not impossible, but hard to do if you don't intend to).
        */
        
        oPythonSysInterpreter = new c_mspython_sys_interpreter(oOvid#).
        oPythonSysInterpreter:QxPy_InitializeInterpreter().
        
        /* Send environment of Progress to the Python environment, as a Python dict */
        oPy# = new c_mspython_call("inherit-env","sc_environment","_InheritAblEnvironmentSettings","panaedra.msroot.msutil.logic.").
        oPy#:clobDataIn = 
          "篚怏舁с蓬雩Е抱筱咤铞轵镱礤铘恒蓬雯篚怏舁р涕鲥蓬雩Ρ趄轫篝蜷铉筱咤铞轵镱礤铘衡涕鲥蓬霈⒃蝓瀵漆祗澧┅篚怏舁с臻惋溴Е抱筱哜镲艉渝篌轱钚狎犴弭弪á臻惋溴┅篚怏舁с予狎邃深槟轵Е抱筱哜镲艉渝篌轱钚狎犴弭弪á予狎邃深槟轵┅篚怏舁с深槟轵Е抱筱唣狒韬闵铋拈颟篚怏舁с田缒轵Е抱筱唣狒韬闾镧拈颟篚怏舁с田缰弪怙箦拈颛Е抱筱唣狒韬闾镧皱蜮矬迥轵篚怏舁с罪螂拈颛Е抱筱唣狒韬阕矧肽轵篚怏舁с藻眇拈颛Е抱筱唣狒韬阍屙鹉轵篚怏舁с尼翎砒汨犷珏拈颛Е抱筱唣狒韬隳狒崤汨犷珏拈颟篚怏舁с尼翎义泔鲥蝙拈颛Е抱筱唣狒韬隳狒嵋邈秭弪拈颟篚怏舁с腻錾效Е抱筱哜镲艉渝篌轱钚狎犴弭弪á腻錾孝┅篚怏舁с萧嵝狒瑙Е抱筱哜镲艉渝篌轱钚狎犴弭弪á萧嵝狒琚┅篚怏舁с馏惋溴Е抱筱哜镲艉渝篌轱钚狎犴弭弪á馏惋溴┅篚怏舁с阵弪赡Е抱筱咤铞轵镱礤铘恒阵弪赡篚怏舁с象阵弪赡Е抱筱咤铞轵镱礤铘恒象阵弪赡篚怏舁с提弪Е抱筱咤铞轵镱礤铘恒提弪篚怏舁с提铉Е抱筱咤铞轵镱礤铘恒提铉篚怏舁с渝篌轱钚殇Е抱筱咤铞轵镱礤铘呵弭序镢弩笊抹┅篚怏舁с渝篌轱钊矬纛犴濮Е抱筱咤铞轵镱礤铘恒蕊篝吾礤篚怏舁с渝篌轱钋蹰洄Е抱筱咤铞轵镱礤铘恒渝篌轱钋蹰洎篚怏舁с渝篌轱钋蹰溆栾螋Е抱筱咤铞轵镱礤铘恒渝篌轱钋蹰溆栾螋篚怏舁с渝篌轱钋蹰湟屙雉濮Е抱筱咤铞轵镱礤铘恒渝篌轱钋蹰湟屙雉濠篚怏舁с罪螂嗅翳Е抱筱哜镲艉渝篌轱钚狎犴弭弪á罪螂嗅翳┅篚怏舁с腻鲈镫孱Е抱筱咤铞轵镱礤铘呵弭象蓬雳⒛弼燥脲睥".
        oPy#:PyRunU().
      end.
    end.

    finally:
      if valid-object(oPy#) then delete object oPy#.
    end finally.    
    
  end method. /* MsPythonInitialize */
  
  
  method public static character PyEval(
    
    /* Simple evaluation and cleanup of a small python fragment.
       If you want more control and efficiency, use a c_mspython_call.cls 
       object.
       Inside your python code, use the special Panaedra python bridge variables:
          cDataIP: for the input character data
          cDataOP: for the returned character data
       Example:
          using panaedra.msroot.mspy.logic.*.
          message sc_mspython:PyEval("cDataOP = 'Hello ' + cDataIP", "World") view-as alert-box. /* codeQok#7222 */
       Example which shows sc_path property synchronization:
          using panaedra.msroot.mspy.logic.*.
          message sc_mspython:PyEval("from panaedra.msroot.msutil.logic.sc_path import sc_path; cDataOP = 'Hello, this is Python\'s sc_path.cLogVerboseDir:\n' + sc_path.cLogVerboseDir + '\n\nand this is my input:\n' + cDataIP", "ABL Input") view-as alert-box. /* codeQok#7222 codeQok#7126 */
     */
    
    cPyCodeIP# as character,
    cDataIP#   as character):
      
    define variable oPyEval# as c_mspython_eval no-undo.
    define variable cReturn# as character       no-undo.
    
    oPyEval# = new c_mspython_eval(cPyCodeIP#).
    
    oPyEval#:clobDataIn = cDataIP#.
    
    oPyEval#:PyRunU().
    
    cReturn# = subst("&1",oPyEval#:clobOutput).
    
    return cReturn#. 
  
    finally:
      if valid-object(oPyEval#) then delete object oPyEval#.
    end finally.    
  
  end method. /* PyEval */

end class.

/* EOF */ 
